generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AppSetting {
  id                       String   @id @default(cuid())
  webhookUrl               String   @default("")
  webhookUsername          String?
  webhookPassword          String?
  webhookHeaders           Json?    // Optional headers as key-value pairs for OAuth etc.
  promptHelperWebhookUrl   String   @default("")
  promptHelperUsername     String?
  promptHelperPassword     String?
  promptHelperHeaders      Json?    // Optional headers as key-value pairs
  timeoutSeconds           Int      @default(1800) // 30 minutes - consolidated timeout
  timeoutEnabled           Boolean  @default(false) // disabled by default
  autoSaveQueries          Boolean  @default(true)
  aiProviderUrl            String?  @default("")
  aiProviderApiKey         String?  @default("")
  // AI Settings
  aiTemperature            Float?   @default(0.7)
  aiTopP                   Float?   @default(1.0)
  aiMaxTokens              Int?     @default(4096)
  aiStream                 Boolean  @default(false)
  aiK                      Int?     @default(5)
  aiRetrievalMethod        String?  @default("none") // rewrite|step_back|sub_queries|none
  aiFrequencyPenalty       Float?   @default(0.0)
  aiPresencePenalty        Float?   @default(0.0)
  aiStop                   Json?    // string or array of strings
  aiStreamOptions          Json?    // {include_usage: boolean}
  aiKbFilters              Json?    // array of KBFilter objects
  aiFilterKbContentByQueryMetadata Boolean @default(false)
  aiIncludeFunctionsInfo   Boolean  @default(false)
  aiIncludeRetrievalInfo   Boolean  @default(false)
  aiIncludeGuardrailsInfo  Boolean  @default(false)
  aiProvideCitations       Boolean  @default(false)
  aiDisableTokenCount      Boolean  @default(false)
  // System Prompts
  aiSystemPrompt           String   @default("")
  aiHelperSystemPrompt     String   @default("")
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String   // Hashed password
  isAdmin   Boolean  @default(false)
  queryCount Int     @default(0)
  savedQueries SavedQuery[]
  aiExperiments AiExperiment[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InvitationCode {
  code      String   @id
  createdAt DateTime @default(now())
  expiresAt DateTime
  usedBy    String?
  usedAt    DateTime?
  revoked   Boolean  @default(false)
}

model SavedQuery {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question         String
  result           Json
  visualizationName String?
  isFavorite       Boolean  @default(false)
  deleted          Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  followUps        FollowUp[]

  @@map("saved_queries")
}

model FollowUp {
  id               String     @id @default(cuid())
  parentQueryId    String
  parentQuery      SavedQuery @relation(fields: [parentQueryId], references: [id], onDelete: Cascade)
  parentFollowUpId String?
  parentFollowUp   FollowUp?  @relation("FollowUpChain", fields: [parentFollowUpId], references: [id], onDelete: Cascade)
  followUps        FollowUp[] @relation("FollowUpChain")
  question         String
  result           Json
  name             String?
  isFavorite       Boolean    @default(false)
  chartType        String?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@map("follow_ups")
}

enum AiExperimentStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum AiRunStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
}

model AiExperiment {
  id             String              @id @default(cuid())
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  label          String
  prompt         String
  expectedAnswer String?
  notes          String?
  totalTargets   Int
  totalCompleted Int                 @default(0)
  status         AiExperimentStatus  @default(PENDING)
  durationMs     Int?
  startedAt      DateTime            @default(now())
  completedAt    DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  targetConfigs  Json?
  results        AiExperimentResult[]
}

model AiExperimentResult {
  id               String       @id @default(cuid())
  experimentId     String
  experiment       AiExperiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  slotIndex        Int
  label            String
  color            String?
  webhookUrl       String?
  modelName        String?
  method           String       @default("POST")
  status           AiRunStatus  @default(QUEUED)
  latencyMs        Int?
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?
  accuracyScore    Float?
  speedScore       Float?
  costEstimate     Float?
  startedAt        DateTime?
  completedAt      DateTime?
  responsePayload  Json?
  errorMessage     String?
  reviewScore      Int?
  feedbackNotes    String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}
